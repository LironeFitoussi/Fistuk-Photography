(()=>{"use strict";var e={859:function(e,t,o){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(o(252)),i=n(o(763)),a=n(o(525)),r=n(o(239)),u=n(o(738)),l=n(o(900)),c=n(o(577)),d=n(o(92)),f=n(o(243)),m=n(o(81)),g=(0,s.default)();g.use((0,a.default)()),g.use(s.default.json({limit:"10kb"})),g.use(s.default.urlencoded({extended:!0,limit:"10kb"}));const p=(0,i.default)({max:1e3,windowMs:36e5,message:"Too many requests from this IP, please try again in an hour!"});g.use("/api",p),g.use((0,r.default)()),g.use((0,u.default)()),g.use((0,l.default)({whitelist:["duration","ratingsQuantity","ratingsAverage","maxGroupSize","difficulty","price"]})),g.use((0,c.default)()),g.options("*",(0,c.default)()),g.use(((e,t,o)=>{e.requestTime=(new Date).toISOString(),o()})),g.use("/api/v1/collections",d.default),g.use("/api/v1/images",f.default),g.use("/api/v1/albums",m.default),g.all("*",((e,t,o)=>{t.status(404).json({status:"fail",message:`Can't find ${e.originalUrl} on this server!`})})),t.default=g},248:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(s,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function r(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}u((n=n.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deleteAlbum=t.createAlbum=t.getAlbumById=t.getAllAlbums=void 0;const i=s(o(791));t.getAllAlbums=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const e=yield i.default.find();t.status(200).json({status:"success",results:e.length,data:{albums:e}})}catch(e){t.status(400).json({status:"fail",message:e})}})),t.getAlbumById=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const o=yield i.default.findById(e.params.id);t.status(200).json({status:"success",data:{album:o}})}catch(e){console.log(e.code);let o="";o=11e3===e.code?"Album already exists":e,t.status(400).json({status:"fail",message:o})}})),t.createAlbum=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const o=yield i.default.create(e.body);t.status(201).json({status:"success",data:{album:o}})}catch(e){console.log(e.code);let o="";o=11e3===e.code?"Album already exists":e,t.status(400).json({status:"fail",message:o})}})),t.deleteAlbum=(e,t)=>n(void 0,void 0,void 0,(function*(){try{yield i.default.findByIdAndDelete(e.params.id),t.status(204).json({status:"success",data:null})}catch(e){t.status(400).json({status:"fail",message:e})}}))},343:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(s,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function r(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}u((n=n.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deleteCollection=t.createCollection=t.getCollectionById=t.getAllCollections=void 0;const i=s(o(129)),a=s(o(941)),r=s(o(791));t.getAllCollections=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const e=yield i.default.find(),o=yield Promise.all(e.map((e=>n(void 0,void 0,void 0,(function*(){const t=yield a.default.find({collectionId:e._id});return Object.assign(Object.assign({},e.toObject()),{images:t})})))));t.status(200).json({status:"success",results:o.length,data:{collections:o}})}catch(e){e instanceof Error?t.status(404).json({status:"fail",message:e.message}):t.status(500).json({status:"fail",message:"An unexpected error occurred"})}})),t.getCollectionById=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const{id:o}=e.params,n=yield i.default.findById(o);if(!n)return t.status(404).json({status:"fail",message:"No collection found with that ID"});const s=yield a.default.find({collectionId:n._id}),r=Object.assign(Object.assign({},n.toObject()),{images:s});t.status(200).json({status:"success",data:{collection:r}})}catch(e){e instanceof Error?t.status(404).json({status:"fail",message:e.message}):t.status(500).json({status:"fail",message:"An unexpected error occurred"})}})),t.createCollection=(e,t)=>n(void 0,void 0,void 0,(function*(){console.log(e.body);const{name:o,albumId:n}=e.body,s=yield r.default.findOne({name:n});if(!s)return t.status(404).json({status:"fail",message:"No album found with that ID"});try{const e=new i.default({name:o,albumId:s._id});yield e.save(),t.status(201).json({status:"success",data:{collection:e}})}catch(e){t.status(400).json({status:"fail",message:e})}})),t.deleteCollection=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const{id:o}=e.params,n=yield i.default.findByIdAndDelete(o);if(!n)return t.status(404).json({status:"fail",message:"No collection found with that ID"});yield a.default.deleteMany({collectionId:n._id}),t.status(204).json({status:"success",data:null})}catch(e){e instanceof Error?t.status(404).json({status:"fail",message:e.message}):t.status(500).json({status:"fail",message:"An unexpected error occurred"})}}))},718:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(s,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function r(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}u((n=n.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deleteImage=t.getImageById=t.getAllImages=t.createImage=void 0;const i=s(o(941)),a=s(o(129)),r=s(o(671));s(o(818)).default.config();const u=s(o(749)),l=o(43),{getSignedUrl:c}=o(701),d=s(o(284)),f=process.env.AWS_BUCKET_NAME;t.createImage=(e,t)=>n(void 0,void 0,void 0,(function*(){var o,s;const{collectionName:c}=e.body;console.log("req.body",e.body),console.log("collectionName",c);const m=yield a.default.findOne({name:c});if(!m)return console.log("Collection not found"),t.status(404).json({message:": Collection not found"});const g=m._id,p=(null===(o=e.files)||void 0===o?void 0:o.length)||0,v=new r.default("Uploading files [:bar] :current/:total :percent :etas",{total:p,width:30,complete:"=",incomplete:" ",renderThrottle:100}),y=null===(s=e.files)||void 0===s?void 0:s.map(((e,t)=>n(void 0,void 0,void 0,(function*(){const t=`${((e=32)=>u.default.randomBytes(e).toString("hex"))()}.jpeg`,o={Bucket:f,Key:t,Body:e.buffer,ContentType:e.mimetype},n=new l.PutObjectCommand(o);try{yield d.default.send(n);const o=new i.default({filename:t,name:e.originalname,collectionId:g});yield o.save(),v.tick()}catch(e){console.error("Failed to upload the image",e)}}))));if(y&&y.length>0)try{yield Promise.all(y),console.log("\nSuccessfully uploaded all images"),v.terminate(),t.status(201).json({message:"All images uploaded successfully"})}catch(e){console.error("Error uploading images:",e),t.status(500).json({message:"An error occurred while uploading images"})}else t.status(400).json({message:"No files provided"})})),t.getAllImages=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const e=yield i.default.find();if(0===e.length)return t.status(404).json({message:"No images found"});const o=yield Promise.all(e.map((e=>n(void 0,void 0,void 0,(function*(){const t={Bucket:f,Key:e.filename},o=new l.GetObjectCommand(t),n=yield c(d.default,o,{expiresIn:3600});return console.log("url",n),Object.assign(Object.assign({},e.toObject()),{url:n})})))));t.status(200).json(o)}catch(e){console.error("Failed to retrieve images:",e),t.status(500).json({message:"Failed to get images",error:e})}})),t.getImageById=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const{id:o}=e.params,n=yield i.default.findById(o);if(!n)return t.status(404).json({message:"Image not found"});t.status(200).json(n)}catch(e){t.status(500).json({message:"Failed to get image",error:e})}})),t.deleteImage=(e,t)=>n(void 0,void 0,void 0,(function*(){try{const{id:o}=e.params;if(!(yield i.default.findByIdAndDelete(o)))return t.status(404).json({message:"Image not found"});t.status(200).json({message:"Image deleted successfully"})}catch(e){t.status(500).json({message:"Failed to delete image",error:e})}}))},791:function(e,t,o){var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,s)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&n(t,e,o);return s(t,e),t},a=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(s,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function r(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(o(37)),u=new r.Schema({name:{type:String,required:!0,unique:!0},date:{type:Date,required:!0},location:{type:String,required:!0},description:{type:String,required:!0},albumCover:{type:String,required:!1,default:"https://www.generationsforpeace.org/wp-content/uploads/2018/03/empty.jpg"},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});u.virtual("collections",{ref:"Collection",localField:"_id",foreignField:"albumId"}),u.set("toJSON",{virtuals:!0}),u.set("toObject",{virtuals:!0}),u.pre(/^find/,(function(e){this.populate({path:"collections",model:"Collection"}),e()})),u.post(/^find/,(function(e,t){return a(this,void 0,void 0,(function*(){t()}))}));const l=r.default.model("Album",u);t.default=l},129:function(e,t,o){var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,s)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&n(t,e,o);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const a=i(o(37)),r=new a.Schema({name:{type:String,required:!0,unique:!0},imageCover:{type:String,required:!1},albumId:{type:a.default.Schema.Types.ObjectId,ref:"Album",required:!0}}),u=a.default.model("Collection",r);t.default=u},941:function(e,t,o){var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,s)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&n(t,e,o);return s(t,e),t},a=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(s,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function r(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}u((n=n.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=i(o(37)),l=o(43),c=o(701),d=r(o(284)),f=process.env.AWS_BUCKET_NAME,m=new u.Schema({name:{type:String,required:!0},filename:{type:String,required:!0},url:{type:String,required:!1},collectionId:{type:u.default.Schema.Types.ObjectId,ref:"Collection",required:!0}});m.post("find",(function(e){return a(this,void 0,void 0,(function*(){for(const t of e){const e={Bucket:f,Key:t.filename},o=new l.GetObjectCommand(e);try{const e=yield(0,c.getSignedUrl)(d.default,o,{expiresIn:3600});t.url=e}catch(e){console.error("Error generating signed URL",e)}}}))}));const g=u.default.model("Image",m);t.default=g},81:function(e,t,o){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(o(252)),i=o(248),a=s.default.Router();a.get("/",i.getAllAlbums),a.get("/:id",i.getAlbumById),a.post("/",i.createAlbum),a.delete("/:id",i.deleteAlbum),t.default=a},92:function(e,t,o){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(o(252)),i=o(343),a=s.default.Router();a.get("/",i.getAllCollections),a.get("/:id",i.getCollectionById),a.post("/",i.createCollection),a.delete("/:id",i.deleteCollection),t.default=a},243:function(e,t,o){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(o(252)),i=o(718),a=s.default.Router(),r=o(461),u=r.memoryStorage(),l=r({storage:u});a.get("/",i.getAllImages),a.get("/:id",i.getImageById),a.post("/",l.array("image"),i.createImage),a.delete("/:id",i.deleteImage),t.default=a},284:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),o(818).config(),o(896);const n=o(43),s=(process.env.AWS_BUCKET_NAME,process.env.AWS_REGION),i=process.env.AWS_ACCESS_KEY||"",a=process.env.AWS_SECRET_KEY||"",r=new n.S3Client({region:s,credentials:{accessKeyId:i,secretAccessKey:a}});t.default=r},997:function(e,t,o){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(o(37)),i=n(o(818)),a=n(o(859));i.default.config({path:"./.env"});const r=process.env.DATABASE.replace("<password>",process.env.DATABASE_PASSWORD),u=process.env.PORT||3e3;process.on("uncaughtException",(e=>{console.log("UNCAUGHT EXCEPTION! 💥 Shutting down..."),console.log(e.name,e.message),process.exit(1)})),process.on("unhandledRejection",(e=>{console.log("UNHANDLED REJECTION! 💥 Shutting down..."),console.log(e.name,e.message),l.close((()=>{process.exit(1)}))}));const l=a.default.listen(u,(()=>{console.log(`App running on port ${u}...`),s.default.connect(r).then((()=>console.log("DB connection successful!")))}))},43:e=>{e.exports=require("@aws-sdk/client-s3")},701:e=>{e.exports=require("@aws-sdk/s3-request-presigner")},577:e=>{e.exports=require("cors")},749:e=>{e.exports=require("crypto")},818:e=>{e.exports=require("dotenv")},252:e=>{e.exports=require("express")},239:e=>{e.exports=require("express-mongo-sanitize")},763:e=>{e.exports=require("express-rate-limit")},525:e=>{e.exports=require("helmet")},900:e=>{e.exports=require("hpp")},37:e=>{e.exports=require("mongoose")},461:e=>{e.exports=require("multer")},671:e=>{e.exports=require("progress")},738:e=>{e.exports=require("xss-clean")},896:e=>{e.exports=require("fs")}},t={};!function o(n){var s=t[n];if(void 0!==s)return s.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,o),i.exports}(997)})();